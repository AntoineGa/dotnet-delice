trigger:
- master

pr: none

variables:
  packageArtifactName: packages

stages:
- stage: build
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'

    variables:
      buildConfiguration: 'Release'
    steps:
    - script: dotnet build --configuration $(buildConfiguration)
      displayName: 'dotnet build $(buildConfiguration)'

    - script: dotnet pack --no-build --no-restore --configuration $(buildConfiguration)
      displayName: 'dotnet pack'

    - script: dotnet run --project src/DotNetDelice
      displayName: Smoke test and example run

    - script: ./fake.sh run build.fsx --target Changelog
      displayName: Generate changelog

    - publish: $(Build.SourcesDirectory)/.nupkg
      displayName: Publish artifacts
      artifact: $(packageArtifactName)

- stage: release
  jobs:
    - deployment: varTest
      displayName: Just some testing
      pool:
        vmImage: 'ubuntu-latest'
      environment: testing
      strategy:
        runOnce:
          deploy:
            steps:
              - script: |
                  echo "Variable from build: $(packageVersion)"
                displayName: Output variables

    - deployment: NuGet
      displayName: Publish tool to NuGet
      pool:
        vmImage: 'ubuntu-latest'
      environment: nuget
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: $(packageArtifactName)

              - task: DotNetCoreCLI@2
                displayName: 'dotnet push'
                enabled: false
                inputs:
                  command: push
                  nuGetFeedType: external
                  packagesToPush: $(Pipeline.Workspace)/$(packageArtifactName)
                  publishFeedCredentials: 'NuGet - dotnet-delice'

    - deployment: GitHub
      displayName: Create GitHub release
      pool:
        vmImage: 'ubuntu-latest'
      environment: github
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: $(packageArtifactName)

              - task: GitHubRelease@0
                displayName: 'Tag and release to GitHub'
                enabled: false
                inputs:
                  gitHubConnection: 'GitHub - dotnet-delice'
                  repositoryName: 'aaronpowell/dotnet-delice'
                  tagSource: manual
                  tag: '$(packageVersion)'
                  title: 'Release $(packageVersion)'
                  releaseNotesSource: input
                  releaseNotesFile: $(Pipeline.Workspace)/$(packageArtifactName)/changelog.md
                  assets: $(Pipeline.Workspace)/$(packageArtifactName)